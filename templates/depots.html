{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-buildings me-2"></i>Depot Hub Hierarchy</h3>
  <a class="btn btn-primary btn-sm" href="{{ url_for('depot_new') }}">
    <i class="bi bi-plus-circle me-1"></i>New Depot
  </a>
</div>

<div class="alert alert-info">
  <i class="bi bi-info-circle me-2"></i>
  <strong>Hub Orchestration Model:</strong>
  <span class="badge bg-success ms-2">MAIN</span> Orchestrates all SUB hubs, approves/executes transfers immediately.
  <span class="badge bg-primary ms-2">SUB</span> Governed by any MAIN hub, transfer requests require MAIN approval.
  <span class="badge bg-warning text-dark ms-2">AGENCY</span> Independent agencies that can request items from MAIN hubs.
</div>

<table class="table table-hover">
  <thead class="table-light">
    <tr>
      <th>Hub ID</th>
      <th>Hub Name</th>
      <th>Hub Type</th>
      <th>Status</th>
      <th>Operational Timestamp</th>
      <th>Total Stock (Units)</th>
      <th class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for loc in locations %}
    <tr {% if loc.status == 'Inactive' %}class="table-secondary"{% endif %}>
      <td>
        <span class="badge bg-light text-dark">{{ loc.id }}</span>
      </td>
      <td>
        {% if loc.hub_type == 'MAIN' %}
          <i class="bi bi-building-fill text-success me-2"></i>
        {% elif loc.hub_type == 'SUB' %}
          <i class="bi bi-diagram-3 text-primary me-2"></i>
        {% elif loc.hub_type == 'AGENCY' %}
          <i class="bi bi-diagram-2 text-warning me-2"></i>
        {% endif %}
        <strong>{{ loc.name }}</strong>
      </td>
      <td>
        {% if loc.hub_type == 'MAIN' %}
          <span class="badge bg-success">MAIN</span>
        {% elif loc.hub_type == 'SUB' %}
          <span class="badge bg-primary">SUB</span>
        {% elif loc.hub_type == 'AGENCY' %}
          <span class="badge bg-warning text-dark">AGENCY</span>
        {% else %}
          <span class="badge bg-secondary">{{ loc.hub_type }}</span>
        {% endif %}
      </td>
      <td>
        {% if loc.status == 'Active' %}
          <span class="badge bg-success">
            <i class="bi bi-check-circle me-1"></i>Active
          </span>
        {% else %}
          <span class="badge bg-secondary">
            <i class="bi bi-x-circle me-1"></i>Inactive
          </span>
        {% endif %}
      </td>
      <td>
        {% if loc.operational_timestamp %}
          <small>
            <i class="bi bi-clock-history me-1"></i>
            {{ loc.operational_timestamp.strftime('%Y-%m-%d %H:%M') }}
          </small>
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>
        {% set stock_qty = stock_by_loc.get(loc.id, 0) %}
        {% if stock_qty > 0 %}
          <span class="badge bg-success fs-6">{{ stock_qty }}</span>
        {% else %}
          <span class="text-muted">{{ stock_qty }}</span>
        {% endif %}
      </td>
      <td class="text-end">
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('depot_inventory', location_id=loc.id) }}">
          <i class="bi bi-box-seam me-1"></i>Inventory
        </a>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('depot_edit', location_id=loc.id) }}">
          <i class="bi bi-pencil me-1"></i>Edit
        </a>
      </td>
    </tr>
  {% else %}
    <tr><td colspan="7" class="text-center py-3">No hubs found. Create one to get started.</td></tr>
  {% endfor %}
  </tbody>
</table>

{% if locations %}
<div class="card mt-4">
  <div class="card-header bg-light">
    <i class="bi bi-diagram-3 me-2"></i>Hub Orchestration Overview
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h6 class="text-success"><i class="bi bi-building-fill me-2"></i>MAIN Hubs (Orchestrators)</h6>
        <ul class="list-unstyled ms-3">
          {% for main_hub in locations if main_hub.hub_type == 'MAIN' %}
            <li class="mb-1">
              <span class="badge bg-success">{{ main_hub.name }}</span>
              {% if main_hub.status == 'Active' %}
                <i class="bi bi-check-circle text-success ms-1"></i>
              {% else %}
                <i class="bi bi-x-circle text-secondary ms-1"></i>
              {% endif %}
            </li>
          {% else %}
            <li class="text-muted small">No MAIN hubs defined</li>
          {% endfor %}
        </ul>
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>MAIN hubs oversee all SUB hubs and can approve any transfer request.
        </small>
      </div>
      
      <div class="col-md-6">
        <h6 class="text-primary"><i class="bi bi-diagram-3 me-2"></i>SUB Hubs (Governed)</h6>
        <ul class="list-unstyled ms-3">
          {% for sub_hub in locations if sub_hub.hub_type == 'SUB' %}
            <li class="mb-1">
              <span class="badge bg-primary">{{ sub_hub.name }}</span>
              {% if sub_hub.status == 'Active' %}
                <i class="bi bi-check-circle text-success ms-1"></i>
              {% else %}
                <i class="bi bi-x-circle text-secondary ms-1"></i>
              {% endif %}
            </li>
          {% else %}
            <li class="text-muted small">No SUB hubs defined</li>
          {% endfor %}
        </ul>
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>SUB hubs are orchestrated by any MAIN hub. No specific parent assignment needed.
        </small>
      </div>
    </div>
    
    {% set agency_hubs = locations|selectattr('hub_type', 'equalto', 'AGENCY')|list %}
    {% if agency_hubs %}
    <hr>
    <div class="row">
      <div class="col-12">
        <h6 class="text-warning"><i class="bi bi-diagram-2 me-2"></i>AGENCY Hubs (Independent)</h6>
        <ul class="list-unstyled ms-3">
          {% for agency in agency_hubs %}
            <li class="mb-1">
              <span class="badge bg-warning text-dark">{{ agency.name }}</span>
              {% if agency.parent_hub %}
                <small class="text-muted ms-2">(Linked to: {{ agency.parent_hub.name }})</small>
              {% endif %}
              {% if agency.status == 'Active' %}
                <i class="bi bi-check-circle text-success ms-1"></i>
              {% else %}
                <i class="bi bi-x-circle text-secondary ms-1"></i>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>AGENCY hubs are independent. They can request items from MAIN hubs.
        </small>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

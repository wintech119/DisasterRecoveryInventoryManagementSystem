{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-buildings me-2"></i>Depot Hub Hierarchy</h3>
  <a class="btn btn-primary btn-sm" href="{{ url_for('depot_new') }}">
    <i class="bi bi-plus-circle me-1"></i>New Depot
  </a>
</div>

<div class="alert alert-info">
  <i class="bi bi-info-circle me-2"></i>
  <strong>Hub Types:</strong>
  <span class="badge bg-success ms-2">MAIN</span> Central hubs can approve transfers immediately.
  <span class="badge bg-primary ms-2">SUB</span> Regional hubs report to MAIN hubs.
  <span class="badge bg-warning text-dark ms-2">AGENCY</span> Agency hubs report to MAIN hubs.
</div>

<table class="table table-hover">
  <thead class="table-light">
    <tr>
      <th>Hub ID</th>
      <th>Hub Name</th>
      <th>Hub Type</th>
      <th>Status</th>
      <th>Parent Hub</th>
      <th>Operational Timestamp</th>
      <th>Total Stock (Units)</th>
      <th class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for loc in locations %}
    <tr {% if loc.status == 'Inactive' %}class="table-secondary"{% endif %}>
      <td>
        <span class="badge bg-light text-dark">{{ loc.id }}</span>
      </td>
      <td>
        {% if loc.hub_type == 'MAIN' %}
          <i class="bi bi-building-fill text-success me-2"></i>
        {% elif loc.hub_type == 'SUB' %}
          <i class="bi bi-diagram-3 text-primary me-2"></i>
          <span class="text-muted ms-2">└─</span>
        {% elif loc.hub_type == 'AGENCY' %}
          <i class="bi bi-diagram-2 text-warning me-2"></i>
          <span class="text-muted ms-2">└─</span>
        {% endif %}
        <strong>{{ loc.name }}</strong>
      </td>
      <td>
        {% if loc.hub_type == 'MAIN' %}
          <span class="badge bg-success">MAIN</span>
        {% elif loc.hub_type == 'SUB' %}
          <span class="badge bg-primary">SUB</span>
        {% elif loc.hub_type == 'AGENCY' %}
          <span class="badge bg-warning text-dark">AGENCY</span>
        {% else %}
          <span class="badge bg-secondary">{{ loc.hub_type }}</span>
        {% endif %}
      </td>
      <td>
        {% if loc.status == 'Active' %}
          <span class="badge bg-success">
            <i class="bi bi-check-circle me-1"></i>Active
          </span>
        {% else %}
          <span class="badge bg-secondary">
            <i class="bi bi-x-circle me-1"></i>Inactive
          </span>
        {% endif %}
      </td>
      <td>
        {% if loc.parent_hub %}
          <i class="bi bi-arrow-return-right me-1 text-muted"></i>
          {{ loc.parent_hub.name }}
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>
        {% if loc.operational_timestamp %}
          <small>
            <i class="bi bi-clock-history me-1"></i>
            {{ loc.operational_timestamp.strftime('%Y-%m-%d %H:%M') }}
          </small>
        {% else %}
          <span class="text-muted">-</span>
        {% endif %}
      </td>
      <td>
        {% set stock_qty = stock_by_loc.get(loc.id, 0) %}
        {% if stock_qty > 0 %}
          <span class="badge bg-success fs-6">{{ stock_qty }}</span>
        {% else %}
          <span class="text-muted">{{ stock_qty }}</span>
        {% endif %}
      </td>
      <td class="text-end">
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('depot_inventory', location_id=loc.id) }}">
          <i class="bi bi-box-seam me-1"></i>Inventory
        </a>
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('depot_edit', location_id=loc.id) }}">
          <i class="bi bi-pencil me-1"></i>Edit
        </a>
      </td>
    </tr>
  {% else %}
    <tr><td colspan="8" class="text-center py-3">No hubs found. Create one to get started.</td></tr>
  {% endfor %}
  </tbody>
</table>

{% if locations %}
<div class="card mt-4">
  <div class="card-header bg-light">
    <i class="bi bi-diagram-3 me-2"></i>Hub Hierarchy Overview
  </div>
  <div class="card-body">
    {% for main_hub in locations if main_hub.hub_type == 'MAIN' %}
      <div class="mb-3">
        <div class="d-flex align-items-center mb-2">
          <i class="bi bi-building-fill text-success me-2 fs-5"></i>
          <strong class="fs-5">{{ main_hub.name }}</strong>
          <span class="badge bg-success ms-2">MAIN HUB</span>
        </div>
        
        {% set child_hubs = locations|selectattr('parent_location_id', 'equalto', main_hub.id)|list %}
        {% if child_hubs %}
          <div class="ms-4">
            {% for child in child_hubs %}
              <div class="d-flex align-items-center mb-1">
                <span class="text-muted me-2">└─</span>
                {% if child.hub_type == 'SUB' %}
                  <i class="bi bi-diagram-3 text-primary me-2"></i>
                  <span class="badge bg-primary">SUB</span>
                {% else %}
                  <i class="bi bi-diagram-2 text-warning me-2"></i>
                  <span class="badge bg-warning text-dark">AGENCY</span>
                {% endif %}
                <span class="ms-2">{{ child.name }}</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="ms-4 text-muted small">
            <i class="bi bi-info-circle me-1"></i>No child hubs assigned
          </div>
        {% endif %}
      </div>
    {% endfor %}
    
    {% if locations|selectattr('parent_location_id', 'none')|selectattr('hub_type', 'ne', 'MAIN')|list %}
      <div class="alert alert-warning mb-0">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Warning:</strong> Some non-MAIN hubs don't have a parent hub assigned. Edit them to link to a MAIN hub.
      </div>
    {% endif %}
  </div>
</div>
{% endif %}
{% endblock %}

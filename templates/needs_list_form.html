{% extends "base.html" %}

{% block title %}{% if is_edit %}Edit{% else %}Create{% endif %} Needs List{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="bi bi-clipboard-{{ 'pencil' if is_edit else 'plus' }} me-2"></i>
          {% if is_edit %}Edit{% else %}Create{% endif %} Needs List
          {% if is_edit %}<span class="badge bg-secondary ms-2">{{ needs_list.status }}</span>{% endif %}
        </h2>
        <a href="{% if is_edit %}{{ url_for('needs_list_details', list_id=needs_list.id) }}{% else %}{{ url_for('needs_lists') }}{% endif %}" class="btn btn-secondary">
          <i class="bi bi-arrow-left me-1"></i>Back
        </a>
      </div>

      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>{{ user_depot.name }}</strong> ({{ user_depot.hub_type }} Hub) - 
        {% if is_edit %}
          Edit your needs list before submitting to ODPEM. All changes will be saved.
        {% else %}
          Create a needs list to request items from ODPEM.
        {% endif %}
      </div>

      <!-- Offline Mode Banner -->
      <div id="offline-mode-banner" class="alert alert-warning" style="display: none;" role="alert">
        <i class="bi bi-wifi-off me-2"></i>
        <strong>Offline Mode:</strong> You are currently offline. This needs list will be saved locally as a draft and synced when connection is restored.
      </div>

      {% if is_edit and needs_list.status == 'Draft' %}
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Draft Status:</strong> This needs list can still be edited. Click "Save as Draft" below to save your changes. After saving, you'll be able to review and submit to ODPEM from the details page.
      </div>
      {% endif %}

      <div class="card shadow-sm">
        <div class="card-body">
          <form method="POST" action="{% if is_edit %}{{ url_for('needs_list_edit', list_id=needs_list.id) }}{% else %}{{ url_for('needs_list_create') }}{% endif %}" id="needsListForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="event_id" class="form-label">Disaster Event (Optional)</label>
                <select class="form-select" id="event_id" name="event_id">
                  <option value="">Select Event</option>
                  {% for event in events %}
                    <option value="{{ event.id }}" {% if is_edit and needs_list.event_id == event.id %}selected{% endif %}>
                      {{ event.name }} - {{ event.start_date.strftime('%Y-%m-%d') }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="priority" class="form-label">Priority <span class="text-danger">*</span></label>
                <select class="form-select" id="priority" name="priority" required>
                  <option value="Low" {% if is_edit and needs_list.priority == 'Low' %}selected{% endif %}>Low</option>
                  <option value="Medium" {% if is_edit and needs_list.priority == 'Medium' %}selected{% elif not is_edit %}selected{% endif %}>Medium</option>
                  <option value="High" {% if is_edit and needs_list.priority == 'High' %}selected{% endif %}>High</option>
                  <option value="Urgent" {% if is_edit and needs_list.priority == 'Urgent' %}selected{% endif %}>Urgent</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label for="notes" class="form-label">Notes</label>
              <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Additional notes about this needs list">{% if is_edit and needs_list.notes %}{{ needs_list.notes }}{% endif %}</textarea>
            </div>

            <hr class="my-4">

            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 class="mb-0"><i class="bi bi-cart-plus me-2"></i>Requested Items</h4>
              <button type="button" class="btn btn-primary btn-sm" id="add-item">
                <i class="bi bi-plus-circle me-1"></i>Add Item
              </button>
            </div>
            
            <div class="table-responsive">
              <table class="table table-hover align-middle" id="items-table">
                <thead class="table-light">
                  <tr>
                    <th scope="col" style="width: 40%;">
                      Item <span class="text-danger">*</span>
                    </th>
                    <th scope="col" style="width: 15%;">
                      Quantity <span class="text-danger">*</span>
                    </th>
                    <th scope="col" style="width: 38%;">
                      Justification
                    </th>
                    <th scope="col" style="width: 7%;" class="text-center">
                      Action
                    </th>
                  </tr>
                </thead>
                <tbody id="items-container">
                  {% if is_edit and needs_list.items %}
                    {# Edit mode: Pre-fill existing items #}
                    {% for item_entry in needs_list.items %}
                      <tr class="item-row">
                        <td>
                          <select class="form-select form-select-sm item-select" name="item_sku_{{ loop.index0 }}" required>
                            <option value="">Select Item</option>
                            {% for item in items %}
                              <option value="{{ item.sku }}" {% if item.sku == item_entry.item_sku %}selected{% endif %}>
                                {{ item.name }} ({{ item.unit }})
                              </option>
                            {% endfor %}
                          </select>
                        </td>
                        <td>
                          <input type="number" class="form-control form-control-sm" name="item_qty_{{ loop.index0 }}" min="1" value="{{ item_entry.requested_qty }}" required>
                        </td>
                        <td>
                          <input type="text" class="form-control form-control-sm" name="item_justification_{{ loop.index0 }}" placeholder="Why is this item needed?" value="{% if item_entry.justification %}{{ item_entry.justification }}{% endif %}">
                        </td>
                        <td class="text-center">
                          <button type="button" class="btn btn-outline-danger btn-sm remove-item" aria-label="Remove item" {% if loop.length == 1 %}style="display:none;"{% endif %}>
                            <i class="bi bi-trash" aria-hidden="true"></i>
                            <span class="visually-hidden">Remove</span>
                          </button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    {# Create mode: One blank row #}
                    <tr class="item-row">
                      <td>
                        <select class="form-select form-select-sm item-select" name="item_sku_0" required>
                          <option value="">Select Item</option>
                          {% for item in items %}
                            <option value="{{ item.sku }}">{{ item.name }} ({{ item.unit }})</option>
                          {% endfor %}
                        </select>
                      </td>
                      <td>
                        <input type="number" class="form-control form-control-sm" name="item_qty_0" min="1" required>
                      </td>
                      <td>
                        <input type="text" class="form-control form-control-sm" name="item_justification_0" placeholder="Why is this item needed?">
                      </td>
                      <td class="text-center">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-item" aria-label="Remove item" style="display:none;">
                          <i class="bi bi-trash" aria-hidden="true"></i>
                          <span class="visually-hidden">Remove</span>
                        </button>
                      </td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>

            <hr class="my-4">

            <div class="d-flex justify-content-between align-items-center">
              <a href="{% if is_edit %}{{ url_for('needs_list_details', list_id=needs_list.id) }}{% else %}{{ url_for('needs_lists') }}{% endif %}" class="btn btn-secondary">Cancel</a>
              <div>
                {% if is_edit %}
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i>Save as Draft
                  </button>
                {% else %}
                  <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-1"></i>Create Needs List
                  </button>
                {% endif %}
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Enhanced table styling for better UX */
#items-table tbody tr {
  transition: background-color 0.2s ease;
}

#items-table tbody tr:hover {
  background-color: rgba(13, 110, 253, 0.05);
}

#items-table thead th {
  font-weight: 600;
  background-color: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  padding: 0.75rem;
}

#items-table td {
  padding: 0.5rem;
  vertical-align: middle;
}

#items-table .form-select-sm,
#items-table .form-control-sm {
  border-radius: 0.25rem;
}

/* Focus states for accessibility */
#items-table .form-select-sm:focus,
#items-table .form-control-sm:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Remove button styling */
.remove-item {
  transition: all 0.2s ease;
}

.remove-item:hover {
  transform: scale(1.1);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  #items-table thead th,
  #items-table td {
    font-size: 0.875rem;
    padding: 0.4rem;
  }
}
</style>

<script>
{% if is_edit %}
  let itemIndex = {{ needs_list.items|length }};
{% else %}
  let itemIndex = 1;
{% endif %}

// Add new item row
document.getElementById('add-item').addEventListener('click', function() {
  const container = document.getElementById('items-container');
  const newRow = document.createElement('tr');
  newRow.className = 'item-row';
  newRow.innerHTML = `
    <td>
      <select class="form-select form-select-sm item-select" name="item_sku_${itemIndex}" required>
        <option value="">Select Item</option>
        {% for item in items %}
          <option value="{{ item.sku }}">{{ item.name }} ({{ item.unit }})</option>
        {% endfor %}
      </select>
    </td>
    <td>
      <input type="number" class="form-control form-control-sm" name="item_qty_${itemIndex}" min="1" required>
    </td>
    <td>
      <input type="text" class="form-control form-control-sm" name="item_justification_${itemIndex}" placeholder="Why is this item needed?">
    </td>
    <td class="text-center">
      <button type="button" class="btn btn-outline-danger btn-sm remove-item" aria-label="Remove item">
        <i class="bi bi-trash" aria-hidden="true"></i>
        <span class="visually-hidden">Remove</span>
      </button>
    </td>
  `;
  container.appendChild(newRow);
  
  // Auto-focus on the first field (item select) of the new row
  const firstField = newRow.querySelector('.item-select');
  if (firstField) {
    firstField.focus();
  }
  
  itemIndex++;
  updateRemoveButtons();
});

// Handle remove button clicks
document.getElementById('items-container').addEventListener('click', function(e) {
  if (e.target.closest('.remove-item')) {
    const row = e.target.closest('.item-row');
    const rows = document.querySelectorAll('.item-row');
    
    // Prevent removing the last row
    if (rows.length > 1) {
      row.remove();
      reindexRows(); // Reindex to prevent gaps in field names
      updateRemoveButtons();
    }
  }
});

// Reindex all rows to ensure sequential numbering (0, 1, 2, 3...)
// This prevents data loss from gaps in field names
function reindexRows() {
  const rows = document.querySelectorAll('.item-row');
  rows.forEach((row, index) => {
    // Update field names to match the new index
    const itemSelect = row.querySelector('.item-select');
    const qtyInput = row.querySelector('input[type="number"]');
    const justInput = row.querySelector('input[type="text"]');
    
    if (itemSelect) itemSelect.name = `item_sku_${index}`;
    if (qtyInput) qtyInput.name = `item_qty_${index}`;
    if (justInput) justInput.name = `item_justification_${index}`;
  });
  
  // Update itemIndex to the next available index
  itemIndex = rows.length;
}

// Update visibility of remove buttons
function updateRemoveButtons() {
  const rows = document.querySelectorAll('.item-row');
  rows.forEach((row) => {
    const removeBtn = row.querySelector('.remove-item');
    if (rows.length > 1) {
      removeBtn.style.display = 'inline-block';
    } else {
      removeBtn.style.display = 'none';
    }
  });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  updateRemoveButtons();
  updateOfflineBanner();
  
  {% if not is_edit %}
  // Add offline support for create mode only (not edit mode)
  setupOfflineSupport();
  {% endif %}
});

// Update offline banner visibility
function updateOfflineBanner() {
  const offlineBanner = document.getElementById('offline-mode-banner');
  if (!navigator.onLine) {
    offlineBanner.style.display = 'block';
  } else {
    offlineBanner.style.display = 'none';
  }
}

// Listen for online/offline events
window.addEventListener('online', updateOfflineBanner);
window.addEventListener('offline', updateOfflineBanner);

// Setup offline support for needs list creation
function setupOfflineSupport() {
  const needsListForm = document.getElementById('needsListForm');
  
  needsListForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Check if offline
    if (!navigator.onLine && window.offlineManager) {
      // Collect form data
      const formData = new FormData(needsListForm);
      const priority = formData.get('priority');
      const notes = formData.get('notes');
      
      // Collect all line items
      const lineItems = [];
      const rows = document.querySelectorAll('.item-row');
      
      rows.forEach((row, index) => {
        const itemSku = formData.get(`item_sku_${index}`);
        const quantity = formData.get(`item_qty_${index}`);
        const justification = formData.get(`item_justification_${index}`);
        
        if (itemSku && quantity) {
          lineItems.push({
            item_sku: itemSku,
            quantity: parseInt(quantity),
            priority: priority,
            notes: justification || ''
          });
        }
      });
      
      if (lineItems.length === 0) {
        alert('Please add at least one item to the needs list');
        return;
      }
      
      // Queue operation for offline sync
      const payload = {
        priority: priority,
        notes: notes,
        line_items: lineItems,
        user_id: {{ current_user.id }}
      };
      
      const result = await window.offlineManager.queueOperation(
        'needs_list_create', 
        {{ user_depot.id }}, 
        payload
      );
      
      if (result.success) {
        alert('âœ“ Needs list queued for sync when online.\n\nThis needs list will be created as a draft and automatically synced when your connection is restored.');
        needsListForm.reset();
        // Reset to one item row
        const container = document.getElementById('items-container');
        container.innerHTML = `
          <tr class="item-row">
            <td>
              <select class="form-select form-select-sm item-select" name="item_sku_0" required>
                <option value="">Select Item</option>
                {% for item in items %}
                  <option value="{{ item.sku }}">{{ item.name }} ({{ item.unit }})</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input type="number" class="form-control form-control-sm" name="item_qty_0" min="1" required>
            </td>
            <td>
              <input type="text" class="form-control form-control-sm" name="item_justification_0" placeholder="Why is this item needed?">
            </td>
            <td class="text-center">
              <button type="button" class="btn btn-outline-danger btn-sm remove-item" aria-label="Remove item" style="display:none;">
                <i class="bi bi-trash" aria-hidden="true"></i>
                <span class="visually-hidden">Remove</span>
              </button>
            </td>
          </tr>
        `;
        itemIndex = 1;
        updateRemoveButtons();
      } else {
        alert('Error queuing needs list: ' + result.error);
      }
    } else {
      // Normal online submission
      needsListForm.submit();
    }
  });
}

// Keyboard shortcuts for better UX
document.addEventListener('keydown', function(e) {
  // Ctrl/Cmd + Enter to submit form
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    document.getElementById('needsListForm').dispatchEvent(new Event('submit'));
  }
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h3><i class="bi bi-clipboard-check me-2"></i>My Needs Lists</h3>
    <p class="text-muted mb-0">Submit requests for disaster relief supplies</p>
  </div>
  <a href="{{ url_for('distributor_create_needs_list') }}" class="btn btn-primary">
    <i class="bi bi-plus-lg me-1"></i>Create New Needs List
  </a>
</div>

{% if unread_notifications %}
<div class="card border-warning mb-4">
  <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-bell-fill me-2 text-warning"></i>Notifications ({{ unread_notifications|length }} Unread)</h5>
    {% if unread_notifications|length > 0 %}
    <form method="post" action="{{ url_for('mark_all_notifications_read') }}" style="display: inline;">
      <button type="submit" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-check-all me-1"></i>Mark All Read
      </button>
    </form>
    {% endif %}
  </div>
  <div class="card-body p-0">
    <div class="list-group list-group-flush">
      {% for notif in unread_notifications %}
      <div class="list-group-item {% if not notif.is_read %}bg-warning bg-opacity-10{% endif %}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-1">
              <i class="bi bi-{% if notif.notification_type == 'partial_fulfillment' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
              Package {{ notif.package.package_number }}
            </h6>
            <p class="mb-2">{{ notif.message }}</p>
            <small class="text-muted">
              <i class="bi bi-clock me-1"></i>{{ notif.created_at.strftime('%Y-%m-%d %H:%M') }}
            </small>
          </div>
          <div class="ms-3 d-flex flex-column gap-2">
            <a href="{{ url_for('package_details', package_id=notif.package_id) }}" class="btn btn-sm btn-primary">
              <i class="bi bi-eye me-1"></i>View Package
            </a>
            <form method="post" action="{{ url_for('mark_notification_read', notification_id=notif.id) }}">
              <button type="submit" class="btn btn-sm btn-outline-secondary w-100">
                <i class="bi bi-check me-1"></i>Mark Read
              </button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% if notifications and notifications|length > unread_notifications|length %}
<div class="card mb-4">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Recent Notification History</h6>
      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#notificationHistoryCollapse" aria-expanded="false" aria-controls="notificationHistoryCollapse">
        <i class="bi bi-chevron-down"></i> Show/Hide
      </button>
    </div>
  </div>
  <div class="collapse" id="notificationHistoryCollapse">
    <div class="card-body p-0">
      <div class="list-group list-group-flush">
        {% for notif in notifications %}
        {% if notif.is_read %}
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <h6 class="mb-1 text-muted">
                <i class="bi bi-check-circle me-2"></i>Package {{ notif.package.package_number }}
              </h6>
              <p class="mb-2 text-muted">{{ notif.message }}</p>
              <small class="text-muted">
                <i class="bi bi-clock me-1"></i>{{ notif.created_at.strftime('%Y-%m-%d %H:%M') }}
              </small>
            </div>
            <div class="ms-3">
              <a href="{{ url_for('package_details', package_id=notif.package_id) }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-eye me-1"></i>View
              </a>
            </div>
          </div>
        </div>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="card">
  <div class="card-header">
    <i class="bi bi-list-ul me-2"></i>Your Needs Lists
  </div>
  <div class="card-body">
    {% if packages %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Package #</th>
            <th>Status</th>
            <th>Items</th>
            <th>Disaster Event</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for pkg in packages %}
          <tr>
            <td><strong>{{ pkg.package_number }}</strong></td>
            <td>
              {% if pkg.status == 'Draft' %}
                <span class="badge bg-secondary">Draft</span>
              {% elif pkg.status == 'Under Review' %}
                <span class="badge bg-warning text-dark">Under Review</span>
              {% elif pkg.status == 'Approved' %}
                <span class="badge bg-success">Approved</span>
              {% elif pkg.status == 'Dispatched' %}
                <span class="badge bg-info text-dark">Dispatched</span>
              {% elif pkg.status == 'Delivered' %}
                <span class="badge bg-dark">Delivered</span>
              {% endif %}
              
              {% if pkg.is_partial %}
                <span class="badge bg-danger ms-1">Partial</span>
              {% endif %}
            </td>
            <td>{{ pkg.items|length }} items</td>
            <td>{{ pkg.event.name if pkg.event else '-' }}</td>
            <td>
              <small>{{ pkg.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
            </td>
            <td>
              <a href="{{ url_for('package_details', package_id=pkg.id) }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-eye me-1"></i>View
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
      <i class="bi bi-clipboard-x" style="font-size: 3rem;"></i>
      <p class="mt-3">You haven't created any needs lists yet.</p>
      <a href="{{ url_for('distributor_create_needs_list') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-1"></i>Create Your First Needs List
      </a>
    </div>
    {% endif %}
  </div>
</div>

<div class="mt-4">
  <div class="card">
    <div class="card-header">
      <i class="bi bi-info-circle me-2"></i>How It Works
    </div>
    <div class="card-body">
      <ol>
        <li><strong>Create</strong> - Submit a needs list with the supplies you require</li>
        <li><strong>Review</strong> - Logistics staff will review stock availability</li>
        <li><strong>Response</strong> - If partial fulfillment, you'll be notified to accept or request revision</li>
        <li><strong>Approval</strong> - Package gets approved and assigned to nearest warehouse</li>
        <li><strong>Dispatch & Delivery</strong> - Package is dispatched and delivered to you</li>
      </ol>
    </div>
  </div>
</div>
{% endblock %}
